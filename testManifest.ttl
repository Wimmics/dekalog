@prefix mf: <http://www.w3.org/2001/sw/DataAccess/tests/test-manifest#> .
@prefix sd: <http://www.w3.org/ns/sparql-service-description#> .
@prefix dkg: <http://ns.inria.fr/kgindex#> .
@prefix earl: <http://www.w3.org/ns/earl#> .
@prefix prov: <http://www.w3.org/ns/prov#> .

<> a mf:Manifest ;
    mf:entries  (
            <test/extraction/reachability.ttl>
            <test/extraction/endpointDescResource.ttl>
            <test/extraction/datasetDescResource.ttl>
            <test/extraction/graphList.ttl>
            <test/extraction/vocabularyList.ttl>
            <test/extraction/tripleCount.ttl>
            <test/extraction/classCount.ttl>
            <test/extraction/classPopulation.ttl>
        ) .

<test/extraction/reachability.ttl> a mf:ManifestEntry ;
    mf:action """PREFIX void: <http://rdfs.org/ns/void#>
        PREFIX dcat: <http://www.w3.org/ns/dcat#>
        PREFIX prov: <http://www.w3.org/ns/prov#>
        PREFIX sd: <http://www.w3.org/ns/sparql-service-description#>
        PREFIX earl: <http://www.w3.org/ns/earl#>
        PREFIX dkg: <http://ns.inria.fr/kgindex#>
        CONSTRUCT {
            $datasetDescription a void:Dataset , dcat:Dataset , prov:Entity , earl:TestSubject .
            $endpointDescription sd:endpoint $endpoint ;
                a sd:Service, dcat:DataService , prov:Entity , earl:TestSubject ;
                sd:availableGraphs [
                   a sd:Dataset ;
                   sd:defaultGraph [
                       a sd:Graph
                   ] ] .
            $metadataDescription a prov:Entity , earl:TestSubject ;
                prov:wasDerivedFrom $endpoint ;
                dkg:curated $datasetDescription , $endpointDescription .
        }
        WHERE {
        }
        """ .

<test/extraction/endpointDescResource.ttl> a mf:ManifestEntry ;
    mf:action """PREFIX sd: <http://www.w3.org/ns/sparql-service-description#>
        PREFIX dkg: <http://ns.inria.fr/kgindex#>
        CONSTRUCT {
            $endpointDescription ?p ?o .
            $metadataDescription dkg:original ?res .
        } WHERE {
            ?res sd:endpoint $endpoint .
            ?res ?p ?o .
        }""" ;
    mf:action """PREFIX sd: <http://www.w3.org/ns/sparql-service-description#>
        PREFIX dkg: <http://ns.inria.fr/kgindex#>
        CONSTRUCT {
           ?s ?p $endpointDescription .
           $metadataDescription dkg:original ?res .
        } WHERE {
           ?res sd:endpoint $endpoint .
           ?s ?p ?res .
        }""" .

<test/extraction/datasetDescResource.ttl> a mf:ManifestEntry ;
    mf:action """PREFIX dcat: <http://www.w3.org/ns/dcat#>
        PREFIX void: <http://rdfs.org/ns/void#>
        PREFIX dkg: <http://ns.inria.fr/kgindex#>
        CONSTRUCT {
            $datasetDescription ?pp ?o .
            $metadataDescription dkg:original ?res .
        }
        WHERE {
            { ?res a dcat:Dataset }
            UNION { ?res a void:Dataset }
            ?res ?p $endpoint .
            ?res ?pp ?o .
         }""" ;
    mf:action """PREFIX dcat: <http://www.w3.org/ns/dcat#>
        PREFIX void: <http://rdfs.org/ns/void#>
        PREFIX dkg: <http://ns.inria.fr/kgindex#>
        CONSTRUCT {
            ?s ?pp $datasetDescription .
            $metadataDescription dkg:original ?res .
        }
        WHERE {
            { ?res a dcat:Dataset }
            UNION { ?res a void:Dataset }
            ?res ?p $endpoint .
            ?s ?pp ?res .
         }""" .

<test/extraction/graphList.ttl> a mf:ManifestEntry ;
    mf:action """PREFIX sd: <http://www.w3.org/ns/sparql-service-description#>
        CONSTRUCT {
            $endpointDescription sd:availableGraphs [
                sd:namedGraph [
                    a sd:NamedGraph ;
                    sd:name ?graph
                ]
            ]
        }
        WHERE {
            GRAPH ?graph { ?s ?p ?o }
        }
        """ .
#            FILTER( REGEX( ?graph, $namespace) )

<test/extraction/vocabularyList.ttl> a mf:ManifestEntry ;
    mf:action """PREFIX void: <http://rdfs.org/ns/void#>
        CONSTRUCT {
        $datasetDescription void:vocabulary ?elem .
    }
    WHERE {
        { ?s ?elem ?o . }
        UNION { ?s ?p ?elem . }
        BIND( REPLACE( str(?elem), "(#|/)[^#/]*$", "$1" ) AS ?ns ) .
    }
    """ .

<test/extraction/tripleCount.ttl> a mf:ManifestEntry ;
    mf:action """PREFIX void: <http://rdfs.org/ns/void#>
        CONSTRUCT {
            $datasetDescription void:triples ?count .
        }
        WHERE {
            SELECT (count(*) AS ?count) WHERE {
                SELECT DISTINCT ?s ?p ?o
                $FROM
                WHERE {
                   ?s ?p ?o .
                }
            }
        }
    """ .

<test/extraction/classCount.ttl> a mf:ManifestEntry ;
    mf:action """PREFIX void: <http://rdfs.org/ns/void#>
        CONSTRUCT {
            $datasetDescription void:classes ?count .
        }
        WHERE {
            SELECT (count(?class) AS ?count)
            WHERE {
                SELECT DISTINCT ?class
                $FROM
                WHERE {
                    { ?class a owl:Class }
                    UNION { ?class a rdfs:Class }
                    UNION { ?whatever a ?class }
                }
            }
        }
    """ .

<test/extraction/propertyCount.ttl> a mf:ManifestEntry ;
    mf:action """PREFIX void: <http://rdfs.org/ns/void#>
        CONSTRUCT {
            $datasetDescription void:properties ?count .
        }
        WHERE {
            SELECT (count(?p) AS ?count)
            WHERE {
                SELECT DISTINCT ?p
                $FROM
                WHERE {
                    ?s ?p ?o
                }
            }
        }
    """ .

<test/extraction/classPopulation.ttl> a mf:ManifestEntry ;
    mf:action """PREFIX void: <http://rdfs.org/ns/void#>
        CONSTRUCT {
            $datasetDescription void:classPartition [
                void:class ?class ;
                void:entities ?count
            ] .
        }
        WHERE {
            SELECT ?class (count(?instance) AS ?count)
            WHERE {
                SELECT DISTINCT ?class ?instance
                $FROM
                WHERE {
                    ?instance a ?class
                }
            }
        }
    """ .
